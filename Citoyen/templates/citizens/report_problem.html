{% extends 'base.html' %}
{% load static %}
{% block title %}Signaler un Problème{% endblock %}

{% block extra_css %}
  <!-- Leaflet CSS for the map (if used in step 2) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    /* Custom styles for the map container */
    #map {
      height: 400px;
      border: 2px solid var(--border-color);
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }
    /* Hide step2 by default */
    .step2 {
      display: none;
    }
  </style>
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white p-6 rounded-lg shadow-lg">
    <!-- Step 1: Choose Category -->
    <div id="step1">
        <h2 class="text-2xl font-bold mb-4 text-center">Étape 1 : Choisir une Catégorie</h2>
        <p class="mb-6 text-center text-gray-600">Veuillez sélectionner le type de problème que vous souhaitez signaler.</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for category in categories %}
            <div class="cursor-pointer category-item bg-gray-50 rounded-lg p-6 border border-gray-200 hover:bg-blue-50 transition-colors duration-200 text-center"
                 onclick="selectCategory('{{ category.id }}', '{{ category.name }}')">
                <!-- Optionally add an icon or image here -->
                <div class="mb-2 text-blue-500 text-3xl">
                    <svg class="w-8 h-8 mx-auto" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                    </svg>
                </div>
                <span class="font-semibold text-gray-800">{{ category.name }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Step 2: Problem Details -->
    <!-- Step 2: Problem Details -->
<!-- Step 2: Problem Details -->
<div id="step2" class="step2">
    <h2 class="text-2xl font-bold mb-4 text-center">Étape 2 : Détails du Problème</h2>
    <p class="mb-6 text-center text-gray-600">Confirmez votre catégorie et entrez les autres informations.</p>
    
    <!-- Begin form -->
    <form method="POST" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      <!-- Hidden field to store the selected category (moved inside the form) -->
      <input type="hidden" id="selected_category" name="selected_category" value="">
      <!-- New hidden field for the municipality candidate, if needed -->
      <input type="hidden" id="municipality_candidate" name="municipality_candidate" value="">
  
      <!-- Optionally display the selected category (read-only) -->
      <div class="mb-4">
        <label class="form-label font-medium">Catégorie Sélectionnée</label>
        <input type="text" id="display_category" value="" readonly
               class="form-input block w-full px-4 py-3 leading-tight text-gray-700 bg-gray-100 border border-gray-300 rounded-lg">
      </div>
  
      <!-- Other form fields -->
      <div class="mb-4">
        <label for="{{ form.description.id_for_label }}" class="form-label">Description du Problème</label>
        {{ form.description }}
        {% if form.description.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.description.errors }}</p>
        {% endif %}
      </div>
      <div class="mb-4">
        <label for="{{ form.photo.id_for_label }}" class="form-label">Photo (facultatif)</label>
        {{ form.photo }}
        {% if form.photo.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.photo.errors }}</p>
        {% endif %}
      </div>
      <div class="mb-4">
        <label for="{{ form.location.id_for_label }}" class="form-label">Adresse / Lieu</label>
        {{ form.location }}
        {% if form.location.errors %}
          <p class="text-red-500 text-sm mt-1">{{ form.location.errors }}</p>
        {% endif %}
      </div>
      <!-- Hidden inputs for latitude and longitude -->
      {{ form.latitude }}
      {{ form.longitude }}
  
      <!-- (Optional) Map container -->
      <div id="map"></div>
  
      <div class="flex justify-center mt-6">
        <button type="submit" class="btn btn-primary">Signaler le problème</button>
      </div>
    </form>
    <!-- End form -->
  </div>
  
  
</div>
{% endblock %}

{% block extra_js %}
  <!-- Leaflet JS (if using the map) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // This function is called when the user selects a category.
        function selectCategory(categoryId, categoryName) {
          // Save the selected category in the hidden input.
          document.getElementById("selected_category").value = categoryId;
          // Display the chosen category (read-only).
          document.getElementById("display_category").value = categoryName;
          // Hide Step 1 and show Step 2.
          document.getElementById("step1").style.display = 'none';
          document.getElementById("step2").style.display = 'block';
          // Request the user's location.
          requestLocation();
        }
      
        function requestLocation() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              showPosition,
              showError,
              { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
            );
          } else {
            alert("La géolocalisation n'est pas supportée par votre navigateur.");
          }
        }
      
        function showPosition(position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          document.getElementById("id_latitude").value = lat;
          document.getElementById("id_longitude").value = lon;
      
          // Initialize non-interactive Leaflet map.
          const map = L.map('map', {
            center: [lat, lon],
            zoom: 18,
            dragging: false,
            zoomControl: false,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            boxZoom: false,
            keyboard: false,
          });
      
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
      
          L.marker([lat, lon], { draggable: false }).addTo(map)
            .bindPopup("Votre position détectée")
            .openPopup();
      
          // Reverse geocode using Nominatim.
          const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=fr`;
          
          fetch(url)
            .then(response => response.json())
            .then(data => {
              // Use display_name from the response.
              const displayName = data.display_name || "";
              // Example: "F-Nord, Nouakchott, Ksar, Nouakchott Ouest, Mauritanie"
              let parts = displayName.split(',');
              // Extract the third component as the municipality candidate, if available.
              let municipalityCandidate = parts.length >= 3 ? parts[2].trim() : "";
              // Update the hidden field for municipality candidate.
              document.getElementById("municipality_candidate").value = municipalityCandidate;
      
              // For the location field, combine full display name with precise coordinates.
              const preciseAddress = `${displayName} (${lat.toFixed(7)}, ${lon.toFixed(7)})`;
              document.getElementById("id_location").value = preciseAddress;
            })
            .catch(err => {
              console.error("Erreur lors de la récupération de l'adresse :", err);
              document.getElementById("id_location").value = `Latitude: ${lat.toFixed(7)}, Longitude: ${lon.toFixed(7)}`;
            });
        }
      
        function showError(error) {
          let msg = "";
          switch (error.code) {
            case error.PERMISSION_DENIED:
              msg = "Vous devez autoriser le partage de votre position pour signaler un problème.";
              break;
            case error.POSITION_UNAVAILABLE:
              msg = "La position est indisponible.";
              break;
            case error.TIMEOUT:
              msg = "La requête de position a expiré.";
              break;
            default:
              msg = "Une erreur s'est produite lors de la récupération de votre position.";
              break;
          }
          alert(msg);
        }
      </script>
      
      
{% endblock %}
